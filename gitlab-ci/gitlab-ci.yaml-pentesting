# Author: Chris Hong | christopher.j.hong@nasa.gov

stages:
    - Building
    - Testing

build:
    stage: Building
    variables:
        GIT_DEPTH: "1000"
    retry:
        max: 2
        when:
            - always
    tags:
        - build
    script:
        - pwd
        - uname -a
        - whoami
        - docker --version
        - BLUE='\033[1;34m'
        - echo -e "\n\n\n${BLUE}[][][][][][][][][][][][][][][][][][][][][][] Building container [][][][][][][][][][][][][][][][][][][][][][]\n\n\n"
        - echo "Note, The login step (next) occasionally produces a '400 Bad Request', please repeat the pipeline if this occurs."
        - docker login gitlab-demo.nccs.nasa.gov:4567 -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        - docker pull jupyterhub/jupyterhub
        - docker tag jupyterhub/jupyterhub:latest gitlab-demo.nccs.nasa.gov:4567/cjhong/jupyter-scan:jupyter-container
        - docker images
        - docker push gitlab-demo.nccs.nasa.gov:4567/cjhong/jupyter-scan:jupyter-container
        - echo "Pushed image to registry, proceeding to testing stage."


predast:
    stage: Testing
    tags:
        - predast
    allow_failure: true
    script:
        - whoami
        - pwd
        - echo "Hurry up DAST, terminating container in 10 minutes"
        - timeout 60s docker run -p 8000:8000 64d82994fd55

dast:
    stage: Testing
    tags:
        - dast
    variables:
        website: "http://127.0.0.1:8000"
    allow_failure: true
    script:
        - sleep 10s
        - whoami
        - docker ps
        - docker run owasp/zap2docker-weekly zap-baseline.py -P 8000 -t http://127.0.0.1:8000
    artifacts:
        reports:
            dast: gl-dast-report.json
